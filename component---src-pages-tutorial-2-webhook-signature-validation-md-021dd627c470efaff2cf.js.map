{"version":3,"file":"component---src-pages-tutorial-2-webhook-signature-validation-md-021dd627c470efaff2cf.js","mappings":"uNAWsBA,E,mFAFTC,EAAe,GAOtBC,GALgBF,EAKY,cALJ,SAA6BG,GAEzD,OADAC,QAAQC,KAAK,aAAeL,EAAO,4EAC5B,eAASG,KAIZG,EAAc,CAClBL,aAAAA,GAEIM,EAAYC,EAAAA,EACH,SAASC,EAAT,GAGX,IAFFC,EAEC,EAFDA,WACGP,GACF,YACD,OAAO,SAACI,GAAD,UAAeD,EAAiBH,EAAhC,CAAuCO,WAAYA,EAAYC,QAAQ,eAI5E,eACE,GAAM,kDADR,mDAGA,mLACA,gGAAiF,uBAAYC,WAAW,KAAvB,qBAAjF,gHAA8P,uBAAYA,WAAW,KAAvB,UAA9P,oBAAoU,uBAAYA,WAAW,KAAvB,eAApU,mMACA,eACE,GAAM,6BADR,8BAGA,0BAAW,uBAAYA,WAAW,KAAvB,qBAAX,oGAA4K,uBAAYA,WAAW,KAAvB,QAA5K,kBAA8O,uBAAYA,WAAW,KAAvB,iBAA9O,qIACA,eACE,GAAM,4BADR,6BAGA,yCAA0B,uBAAYA,WAAW,KAAvB,UAA1B,6HACA,qBAAK,iBAAMA,WAAW,MAClB,UAAa,uBADZ,kHAML,eACE,GAAM,+BADR,gBAEmB,uBAAYA,WAAW,MAAvB,UAFnB,cAGA,iCAAkB,uBAAYA,WAAW,KAAvB,UAAlB,4EAAgJ,uBAAYA,WAAW,KAAvB,UAAhJ,0FAA4R,uBAAYA,WAAW,KAAvB,UAA5R,4EACA,6FAA8E,uBAAYA,WAAW,KAAvB,SAA9E,+CAA8K,mBAAQA,WAAW,KAAnB,OAA9K,oCACA,SAACV,EAAD,CAAaW,MAAM,OAAOF,QAAQ,iBAClC,kHAAmG,uBAAYC,WAAW,KAAvB,SAAnG,2BAA+K,uBAAYA,WAAW,KAAvB,QAA/K,sCACA,6CAA8B,uBAAYA,WAAW,KAAvB,UAA9B,+BACA,qBAAK,iBAAMA,WAAW,MAClB,UAAa,uBADZ,okBAqBL,eACE,GAAM,wBADR,yBAGA,2EACA,qBAAK,iBAAMA,WAAW,MAClB,UAAa,uBADZ,mCAIL,uQAAwP,cAAGE,KAAK,wCAAwCC,OAAO,QAAvD,qBAAxP,iCACA,4NACA,SAAC,IAAD,CAAQC,YAAY,wCAAwCL,QAAQ,YACpE,eACE,GAAM,aADR,cAGA,gGAAiF,cAAGC,WAAW,IAC3F,KAAQ,iCADqE,UAAjF,MAOJH,EAAWQ,gBAAiB","sources":["webpack://cloudmanager-api-docs/./src/pages/tutorial/2-webhook-signature-validation.md"],"sourcesContent":["import * as React from 'react'\n  /* @jsx mdx */\nimport { mdx } from '@mdx-js/react';\n/* @jsxRuntime classic */\n\n/* @jsx mdx */\n\nimport DefaultLayout from \"/home/runner/work/cloudmanager-api-docs/cloudmanager-api-docs/node_modules/@adobe/gatsby-theme-aio/src/components/MDXFilter/index.js\";\nimport Glitch from \"../../components/glitch\";\nexport const _frontmatter = {};\n\nconst makeShortcode = name => function MDXDefaultShortcode(props) {\n  console.warn(\"Component \" + name + \" was not imported, exported, or provided by MDXProvider as global scope\");\n  return <div {...props} />;\n};\n\nconst InlineAlert = makeShortcode(\"InlineAlert\");\nconst layoutProps = {\n  _frontmatter\n};\nconst MDXLayout = DefaultLayout;\nexport default function MDXContent({\n  components,\n  ...props\n}) {\n  return <MDXLayout {...layoutProps} {...props} components={components} mdxType=\"MDXLayout\">\n\n\n\n    <h1 {...{\n      \"id\": \"tutorial-step-2---webhook-signature-validation\"\n    }}>{`Tutorial Step 2 - Webhook Signature Validation`}</h1>\n    <p>{`In the second step of the tutorial, the webhook from the first step is going to be enhanced to validate that the POST request actually comes from Adobe I/O.`}</p>\n    <p>{`POST requests to the webhook are signed using a SHA256 HMAC stored in the `}<inlineCode parentName=\"p\">{`x-adobe-signature`}</inlineCode>{` header. There's a few different ways this can be done, but the approach used in this tutorial is using the `}<inlineCode parentName=\"p\">{`verify`}</inlineCode>{` feature of the `}<inlineCode parentName=\"p\">{`body-parser`}</inlineCode>{` package. This uses a function which is called on every request. If an error is thrown inside this function, the request is immediately rejected. This helps to keep the route function clean.`}</p>\n    <h2 {...{\n      \"id\": \"setting-up-the-secret-key\"\n    }}>{`Setting up the Secret Key`}</h2>\n    <p>{`The `}<inlineCode parentName=\"p\">{`x-adobe-signature`}</inlineCode>{` header value is generated using the Client Secret value, so the first step is to make sure the `}<inlineCode parentName=\"p\">{`.env`}</inlineCode>{` file has the `}<inlineCode parentName=\"p\">{`CLIENT_SECRET`}</inlineCode>{` variable populated. You should have done this in Step 0, but if not (or if you are using Glitch), you will need to do this now.`}</p>\n    <h2 {...{\n      \"id\": \"using-the-crypto-library\"\n    }}>{`Using the crypto library`}</h2>\n    <p>{`Node.js's standard `}<inlineCode parentName=\"p\">{`crypto`}</inlineCode>{` module supports all of the cryptographic functions needed for this. It just needs to be added to the top of the script:`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-javascript\"\n      }}>{`const express = require(\"express\"),\n  bodyParser = require(\"body-parser\"),\n  crypto = require(\"crypto\");\n`}</code></pre>\n    <h2 {...{\n      \"id\": \"writing-the-verify-function\"\n    }}>{`Writing the `}<inlineCode parentName=\"h2\">{`verify`}</inlineCode>{` function`}</h2>\n    <p>{`The actual `}<inlineCode parentName=\"p\">{`verify`}</inlineCode>{` function accepts the request and response objects along with a Node.js `}<inlineCode parentName=\"p\">{`Buffer`}</inlineCode>{`. It first reads the signature from the headers. Then it generates the HMAC using the `}<inlineCode parentName=\"p\">{`Buffer`}</inlineCode>{`. Finally, it compares a Base64 digest of the HMAC to the header value.`}</p>\n    <p>{`We also need to handle the case where the header isn't provided, so an `}<inlineCode parentName=\"p\">{`Error`}</inlineCode>{` should be thrown if there is no signature `}<strong parentName=\"p\">{`and`}</strong>{` the request is a POST request.`}</p>\n    <InlineAlert slots=\"text\" mdxType=\"InlineAlert\" />\n    <p>{`There might be cases where you want to disable this checked, so the code below allows for a `}<inlineCode parentName=\"p\">{`DEBUG`}</inlineCode>{` variable to be set in `}<inlineCode parentName=\"p\">{`.env`}</inlineCode>{` to allow unsigned POSTs through.`}</p>\n    <p>{`Fully implemented, the `}<inlineCode parentName=\"p\">{`verify`}</inlineCode>{` function looks like this:`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-javascript\"\n      }}>{`app.use(\n  bodyParser.json({\n    verify: (req, res, buf, encoding) => {\n      const signature = req.header(\"x-adobe-signature\");\n      if (signature) {\n        const hmac = crypto.createHmac(\"sha256\", process.env.CLIENT_SECRET);\n        hmac.update(buf);\n        const digest = hmac.digest(\"base64\");\n\n        if (signature !== digest) {\n          throw new Error(\"x-adobe-signature HMAC check failed\");\n        }\n      } else if (!process.env.DEBUG && req.method === \"POST\") {\n        throw new Error(\"x-adobe-signature required\");\n      }\n    },\n  })\n);\n`}</code></pre>\n    <h2 {...{\n      \"id\": \"updating-the-webhook\"\n    }}>{`Updating the Webhook`}</h2>\n    <p>{`To update your webhook script, just replace the line`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-javascript\"\n      }}>{`app.use(bodyParser.json());\n`}</code></pre>\n    <p>{`with the block above. If you are running the script locally, you'll need to stop and restart the node process. You don't need to restart ngrok. In fact, if you do restart ngrok, the URL will likely change and you'll need to go back into the `}<a href=\"https://console.adobe.io/integrations\" target=\"_new\">{`Adobe I/O Console`}</a>{` and update the Webhook URL.`}</p>\n    <p>{`If you are running the script through Glitch, Glitch will restart automatically. If you don't want to update your existing Glitch project (or lost it), you can click the button below to start over.`}</p>\n    <Glitch projectName=\"adobe-cloudmanager-api-tutorial-step2\" mdxType=\"Glitch\" />\n    <h2 {...{\n      \"id\": \"next-step\"\n    }}>{`Next Step`}</h2>\n    <p>{`With all that done, you're ready to proceed to the next step. Continue to `}<a parentName=\"p\" {...{\n        \"href\": \"3-handling-specific-events.md\"\n      }}>{`Step 3`}</a>{`.`}</p>\n\n    </MDXLayout>;\n}\n;\nMDXContent.isMDXComponent = true;\n      "],"names":["name","_frontmatter","InlineAlert","props","console","warn","layoutProps","MDXLayout","DefaultLayout","MDXContent","components","mdxType","parentName","slots","href","target","projectName","isMDXComponent"],"sourceRoot":""}